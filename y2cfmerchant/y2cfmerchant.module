<?php
function y2cfmerchant_menu_alter(&$items) {
	global $user;
	if($user->uid != '1') {
		$items['node/%node/edit']['type'] = MENU_CALLBACK;
		$items['user/%user/edit']['type'] = MENU_CALLBACK;
		unset($items['user/%user/edit']['type']);
		
	}
	return $items;
}
function y2cfmerchant_form_alter(&$form, $form_state, $form_id) {
	global $base_url;
	global $user;
	/***		Comment form alteration	***/
	if ($form_id === 'comment_form') {
		$form['hello']['comment_status'] = array(
      '#title' => t('Status'),
      '#type'=> 'textfield',
      '#weight'=> 2
		);
		$form['#submit'][] = 'y2cf_comment_status_submit';
	}
	/***		User registration alteration	**/
	if ($form_id === 'user_register') {
    $form['path']['#access'] = FALSE;
		$form['menu']['#access'] = FALSE;
		$form['author']['#access'] = FALSE;
		$form['options']['#access'] = FALSE;
		$form['comment_settings']['#access'] = FALSE;
		$form['revision_information']['#access'] = FALSE;
		$sql_my_sp .= "select rr.rid, us.uid,us.name from {users} us inner join {users_roles} ur on us.uid=ur.uid inner join {role} rr on ur.rid=rr.rid where (rr.name='reporting manager' or rr.name='salesmanager' or rr.name='y2cfmanager' or rr.name='operationhead' or rr.name='operationmngr' or rr.name='y2cfproducts' ) ";

		$sql_my_sp .= "order by name asc";
		$sql_obj = db_query($sql_my_sp);
		$y2cf_sales_arr = array(''=>'Select RM', '1'=>'Izhar Ashraf(Dev)');

		while($rs = db_fetch_array($sql_obj)){
			$sql_role = db_result(db_query("SELECT name from {role} where rid='".$rs['rid']."' "));
			if($sql_role =='reporting manager') {
				$role_name = 'Sales Head';
			}
			elseif($sql_role =='salesmanager') {
				$role_name = 'Sales Manager';
			}
			elseif($sql_role =='y2cfmanager') {
				$role_name = 'Y2CF Administrator';
			}
			elseif($sql_role =='operationhead') {
				$role_name = 'Operation Head';
			}
			elseif($sql_role =='operationmngr') {
				$role_name = 'Operation Manager';
			}elseif($sql_role =='y2cfproducts') {
        $role_name = 'Product Manager';
      }
			else {
				  $role_name = '';
			}
      $y2cf_sales_arr[$rs['uid']] = $rs['name'].' ( '.$role_name.' ) ';
		}
		$form['user_id'] = array(
	      '#title' =>'Select Reporting Manager',
	      '#description' => '',
	      '#type' =>'select',
	      '#options' =>$y2cf_sales_arr,
	      '#default_value'=> "",
		);


		$form['#submit'][] = 'user_submit_profile';
	}
//Mail Communication sent to merchant outlets

	
	/*****		Merchants outlet alteration		****/
	if ($form_id == 'merchant_outlet_node_form') {

    //Creative design
	$rs_rid  = get_user_role_id($user->uid);


	$out_nid = arg(1);
      $merchant_det = db_result(db_query("Select distinct field_hopper_merchant_olt_nid from {content_type_merchant_outlet} where nid='{$out_nid}' "));
      $node_vid = db_result(db_query("Select vid from {node} where nid='{$merchant_det}' "));
      $sale_offer_detail = db_fetch_object(db_query("Select n.*,ctod.* from {node} n inner join {content_type_offer_detail} ctod on n.vid=ctod.vid where n.vid='{$node_vid}' "));





	 if ($rs_rid == 'posbrand') {
      $form['title']['#access'] = FALSE;
    }
	if ($rs_rid == 'hopproffer testing') {
      $form['title']['#access'] = FALSE;
    }
	  if ($rs_rid == 'operationheadexec') {
      $form['title']['#access'] = FALSE;
    }
	 if ($rs_rid == 'hopprofferupload') {
      $form['title']['#access'] = FALSE;
    }
	 if ($rs_rid == 'hopproffertesting') {
      $form['title']['#access'] = FALSE;
    }
	if ($rs_rid == 'y2cfproducts' || $rs_rid == 'hopprofferupload' || $user->uid == 1) {
      $form['title']['#access'] = FALSE;


      $hoppr_offer_det .= '<div id="container">
      <div id="conatain">
<div class="content clear-block">
<div>'.ucwords($sale_offer_detail->title).' , '.date("m/d/Y - H:i:s", $sale_offer_detail->created). " by ". ucwords(get_salesperson_name($sale_offer_detail->uid)) .'</div>
  <fieldset>
    <legend><span style="color:red;">Merchant Specifics</span></legend>';
//Offer description for merchant category A C and D
      $offer_detail = (!empty($sale_offer_detail->field_hopper_checkin1_value)) ? $sale_offer_detail->field_hopper_checkin1_value : $sale_offer_detail->field_offer_description_value;
      $hoppr_offer_det .='<div><strong>Merchant Name:</strong></div><div>'.$sale_offer_detail->title.'</div>
      <div><strong>Keyword:</strong></div><div style="color:blue;">'.$sale_offer_detail->field_hop_ops_pro_keywords_value.'</div>
      <div><strong>Genre:</strong></div><div>'.get_only_term_name($sale_offer_detail->field_genre_value).'</div>
      <div><strong>Merchant Category:</strong></div><div>'.get_only_term_name($sale_offer_detail->field_hop_merch_type_value).'</div>
    <div><strong>Offer Description for D Category / Checkin offer for C Category / Tip for A category:</strong></div><div>'.$offer_detail.'</div>
    <div><strong>Offer Validity:</strong></div><div>'.$sale_offer_detail->field_offer_coupon_validity_value.' days</div>
    <div><strong>Fine Print2:Number of People Voucher Valid for:</strong></div><div>'.$sale_offer_detail->field_no_of_plp_voucher_value.'</div>';

      $hoppr_offer_det .='</div></fieldset>';
      $hoppr_offer_det .= hoppr_get_merchant_outlet_detail($out_nid);
      $hoppr_offer_det .='</div></div>';
      $form['complt_offer_det_msg'] = array(
        '#type' => 'item',
        '#weight' => -19,
        '#description' => '<div>'.$hoppr_offer_det.'</div>'
        );

	}
  if ($rs_rid == 'hopprcreativedesign') {
	$form['title']['#access'] = FALSE;


	$ops_outlet_sql_offer = "SELECT nn.*, nn.uid as sales,ctmout.*, nr.*, nr.uid as executive, nr.title as outlet_name, nr.timestamp as ops_changed_date FROM {node} nn inner join {node_revisions} nr on nn.vid = nr.vid inner join {content_type_merchant_outlet} ctmout  ON ctmout.vid = nr.vid ";
    $ops_outlet_sql_offer .= " and ctmout.field_hopper_merchant_olt_nid = '".$out_nid."' ";
    $rs_kw = db_fetch_array(db_query($ops_outlet_sql_offer));

    if(!empty($rs_kw['field_hop_ops_pro_keywords_value'])) {
    	$kwds = $rs_kw['field_hop_ops_pro_keywords_value'];
    }elseif(!empty($rs_kw['field_hop_ops_pro_kwds_mo_value'])){
    	$kwds = $rs_kw['field_hop_ops_pro_kwds_mo_value'];
    }else{
    	$kwds = '-';
    }

    $kwywds = '<div><strong>Keyword:</strong></div><div style="color:blue;">'.$sale_offer_detail->field_hop_ops_pro_keywords_value.'</div>';
$form['keywrds_msg'] = array(
        '#type' => 'item',
        '#weight' => -19,
        '#description' => $kwywds
        );
    }



		$form['outletdtls_msg'] = array(
        '#type' => 'item',
        '#weight' => -19,
        '#description' => '<div><span style="color:red;">Fields Mark with </span>(<span style="color:#FFAE00;">*</span>) <span style="color:red;"> is mandatory!</span></div>'
        );

		if (isset($form_state['node_preview'])) {
			$form['my_node_preview_1'] = array(
        '#type' => 'submit',
        '#weight' => -20,
        '#value' => t('Save'),
        '#submit' => array('node_form_submit'),
			);
			$form['my_node_preview'] = array(
        '#type' => 'item',
        '#weight' => -20,
        '#description' => '<div><table>
							<tr><td><a href="#edit-title-wrapper">Edit Merchant Outlet</a></span></td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							<tr><td>&nbsp;</td></tr>
							</table></div>'
							);
		}
		
		
		if(arg(0)=='node' && (arg(1)=='add' || is_numeric(arg(1)) ) && (arg(2)=='merchant-outlet' || arg(2)=='edit')) {
			$form['#validate'][] = 'hoppr_lat_lon_validate';
		}
		
		//$form['#after_build'][] = 'hoppr_lat_lon_atedit_after_build';
		
		$form['path']['#access'] = FALSE;
		$form['menu']['#access'] = FALSE;
		$form['author']['#access'] = FALSE;
		$form['options']['#access'] = FALSE;
		$form['comment_settings']['#access'] = FALSE;
		$form['revision_information']['#access'] = FALSE;
		$form['buttons']['preview']['#weight'] = 19;
		$form['buttons']['submit']['#weight'] = 20;
	}
/******		Merchant Offer detail Form alteration	********/
	if ($form_id == 'offer_detail_node_form') {

//  Merchant offer detail shows to ops telecaller
    $rs_rid  = get_user_role_id($user->uid);
    if ($rs_rid == 'posbrand') {
      $form['title']['#access'] = FALSE;
    }
//Rejection case field status 
	if(arg(0)=='node' && arg(1)=='add' && arg(2)=='offer-detail') {
      $form['field_hoppr_rej_cases']['#access'] = FALSE;
      $form['field_hop_rej_cs_sts_rmks']['#access'] = FALSE;
      
    }

	  if ($rs_rid == 'hopprcreativedesign') {
	  	$mer_nid = arg(1);
	  	$mer_detail = node_load($mer_nid);
      $offer_vid = $mer_detail->vid;
      $sale_offer_detail = db_fetch_object(db_query("Select field_hop_ops_pro_keywords_value from {content_type_offer_detail} where vid='{$offer_vid}' "));
      $hoppr_keywords = '<div>Keyword:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'.$sale_offer_detail->field_hop_ops_pro_keywords_value.'</div>';
      $form['title']['#access'] = FALSE;
      $form['keywrds_msg'] = array(
        '#type' => 'item',
        '#weight' => -19,
        '#description' => '<div>'.$hoppr_keywords.'</div>'
        );

      $form['offerdtl_msg'] = array(
        '#type' => 'item',
        '#weight' => -19,
        '#description' => '<div><span style="color:red;">Fields Mark with </span>(<span style="color:#FFAE00;">*</span>) <span style="color:red;"> is mandatory!</span></div>'
        );
    }

		if ($rs_rid == 'operationheadexec') {
      $form['title']['#access'] = FALSE;
}

    if ($rs_rid == 'y2cfproducts' || $rs_rid == 'hopprofferupload') {
    	$form['title']['#access'] = FALSE;
      $mer_nid = arg(1);
      $mer_detail = node_load($mer_nid);
      $offer_vid = $mer_detail->vid;
      $sale_offer_detail = db_fetch_object(db_query("Select * from {content_type_offer_detail} where vid='{$offer_vid}' "));
      $hoppr_offer_det = '';
    	$hoppr_offer_det .= '<div id="container">
      <div id="conatain">
<div class="content clear-block">
<div>'.ucwords($mer_detail->title).' , '.date("m/d/Y - H:i:s", $mer_detail->created). " by ". ucwords(get_salesperson_name($mer_detail->uid)) .'</div>
  <fieldset>
    <legend><span style="color:red;">Merchant Specifics</span></legend>';
//Offer description for merchant category A C and D
      $offer_detail = (!empty($sale_offer_detail->field_hopper_checkin1_value)) ? $sale_offer_detail->field_hopper_checkin1_value : $sale_offer_detail->field_offer_description_value;
      $hoppr_offer_det .='<div><strong>Genre:</strong></div><div>'.get_only_term_name($sale_offer_detail->field_genre_value).'</div>
    <div><strong>Offer Validity:</strong></div><div>'.$sale_offer_detail->field_offer_coupon_validity_value.' days</div>
    <div><strong>Offer Description for D Category / Checkin offer for C Category / Tip for A category:</strong></div><div>'.$offer_detail.'</div>
    <div><strong>Fine Print2:Number of People Voucher Valid for:</strong></div><div>'.$sale_offer_detail->field_no_of_plp_voucher_value.'</div>
    ';
      $hoppr_offer_det .='</div></fieldset>';
      $hoppr_offer_det .= hoppr_get_merchant_outlet_detail($mer_nid);
      $hoppr_offer_det .='</div></div>';
      $form['complt_offer_det_msg'] = array(
        '#type' => 'item',
        '#weight' => -19,
        '#description' => '<div>'.$hoppr_offer_det.'</div>'
        );
      $form['offerdtl_msg'] = array(
        '#type' => 'item',
        '#weight' => -19,
        '#description' => '<div><span style="color:red;">Fields Mark with </span>(<span style="color:#FFAE00;">*</span>) <span style="color:red;"> is mandatory!</span></div>'
        );

    }


//Ops Caller

	if (($rs_rid == 'hoppertelecallingops' || $rs_rid == 'operationmngr' || $user->uid == 1) && (arg(2)=='edit')) {
      $mer_nid = arg(1);
      $mer_detail = node_load($mer_nid);
      $offer_vid = $mer_detail->vid;
      $sale_offer_detail = db_fetch_object(db_query("Select * from {content_type_offer_detail} where vid='{$offer_vid}' "));
      $hoppr_offer_det = '';
      $hoppr_offer_det .= '<div id="container">
      <div id="conatain">
<div class="content clear-block">
<div>'.ucwords($mer_detail->title).' , '.date("m/d/Y - H:i:s", $mer_detail->created). " by ". ucwords(get_salesperson_name($mer_detail->uid)) .'</div>';

      $rs_ops_exe = get_ops_exe_ror($mer_nid);
      $hoppr_offer_det .='<fieldset><legend><span style="color:red;">Operation by operation Executive</span></legend>
      <div>
        <div><strong>Outlet Status: Easy to find?:</strong></div>
        <div>'.$sale_offer_detail->field_hop_offer_ops_easyfind_value.'</div>
        <div><strong>Cleanliness & Hygienic:</strong></div>
        <div>'.$sale_offer_detail->field_hop_offer_clean_in_out_value.'</div>
        <div><strong>Ambience:</strong></div>
        <div>'.$sale_offer_detail->field_hop_offer_ambiance_value.'</div>
        <div><strong>Behavior Check:</strong></div>
        <div>'.$sale_offer_detail->field_hop_offer_beh_chk_value.'</div>
        <div><strong>Offer Launch:</strong></div>
        <div>'.$sale_offer_detail->field_hop_offer_launch_value.'</div>
        <div><strong>Operation Status:</strong></div>
        <div>'.$sale_offer_detail->field_hop_offer_ops_status_value.'</div>
        <div><strong>Agreement Status:</strong></div>
        <div>'.$sale_offer_detail->field_hop_ops_exe_sta_value.'</div>
        <div><strong>Ops Exe. Reason of rejection:</strong></div>
        <div>'.$rs_ops_exe.'</div>
        <div><strong>Operation Comments:</strong></div>
        <div>'.$sale_offer_detail->field_hop_offer_ops_comments_value.'</div>
    </div>
  </fieldset>';
      $rs_ops_manager_ror = get_ops_manager_ror($mer_nid);
      $hoppr_offer_det .='<fieldset><legend><span style="color:blue;">Operation by operation Manager</span></legend>
      <div>
        <div><strong>Agreement status:</strong></div>
        <div>'.$sale_offer_detail->field_hop_ops_agr_sta_value.'</div>
        <div><strong>Reason of rejection:</strong></div>
        <div>'.$rs_ops_manager_ror.'</div>
        <div><strong>Comments:</strong></div>
        <div>'.$sale_offer_detail->field_hop_mo_om_comments_value.'</div>
    </div>
  </fieldset>';
      $rs_pro_ror = get_pro_mngr_ror($mer_nid);
      $hoppr_offer_det .='<fieldset><legend><span style="color:red;">Product Ops Status</span></legend>
      <div>
        <div><strong>Evaluation Status:</strong></div>
        <div>'.$sale_offer_detail->field_hop_pro_evaluation_status_value.'</div>
        <div><strong>Reason for Rejection:</strong></div>
        <div>'.$rs_pro_ror.'</div>
        <div><strong>Comments:</strong></div>
        <div>'.$sale_offer_detail->field_hop_pro_otherscom_value.'</div>

        <div><strong>Keywords:</strong></div>
        <div>'.$sale_offer_detail->field_hop_ops_pro_keywords_value.'</div>
        <div><strong>Offer Description SMS:</strong></div>
        <div>'.$sale_offer_detail->field_hop_pro_offer_desc_value.'</div>

        <div><strong>Coupon code script:</strong></div>
        <div>'.$sale_offer_detail->field_hop_ops_coupon_code_value.'</div>

        <div><strong>Merchant SMS script(D category):</strong></div>
        <div>'.$sale_offer_detail->field_hop_ops_pro_mersms_value.'</div>
    </div>
  </fieldset>';
//Merchant Address implementation
      $hoppr_offer_det .= hoppr_get_merchant_outlet_detail($mer_nid);
      $hoppr_offer_det .='</div></div>';
      $form['complt_offer_det_msg'] = array(
        '#type' => 'item',
        '#weight' => -19,
        '#description' => '<div>'.$hoppr_offer_det.'</div>'
        );

      $form['offerdtl_msg'] = array(
        '#type' => 'item',
        '#weight' => -19,
        '#description' => '<div><span style="color:red;">Fields Mark with </span>(<span style="color:#FFAE00;">*</span>) <span style="color:red;"> is mandatory!</span></div>'
        );

    }
    if (isset($form_state['node_preview'])) {
			$form['my_node_preview_1'] = array(
			  '#type' => 'submit',
			  '#weight' => -20,
			  '#value' => t('Save'),
			  '#submit' => array('node_form_submit'),
			  '#attributes' => array("onclick" => "javascript: return confirm('Are you sure');this.value='Please Wait...'; this.disabled = true;"),
			);
			$form['my_node_preview'] = array(
				'#type' => 'item',
				'#weight' => -19,
				'#description' => '<div><table>
										<tr><td><a href="#edit-title-wrapper">Edit Merchant Offer</a></span></td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										<tr><td>&nbsp;</td></tr>
										</table></div>'
										);
		}

		  $form['path']['#access'] = FALSE;
		  $form['menu']['#access'] = FALSE;
		  $form['author']['#access'] = FALSE;
		  $form['options']['#access'] = FALSE;
		  $form['comment_settings']['#access'] = FALSE;
		  $form['revision_information']['#access'] = FALSE;
		  $form['buttons']['preview']['#weight'] = 19;
		  $form['buttons']['submit']['#weight'] = 20;
// Disable status comment field
		  $rs_rid = db_result(db_query("select rr.name from {users_roles} ur inner join {role} rr on ur.rid=rr.rid where ur.uid='".$user->uid."' "));
		if($rs_rid == 'salesperson' && arg(2)=='edit') {
			$form['#after_build'][] = '_mysnippet_after_build';
		}
	}

	/*****		DSR Form alteration		******/

	if ($form_id == 'y2cf_dsr_node_form') {
		if(arg(0)=='node' && arg(1)=='add' && arg(2)=='y2cf-dsr') {
			$form['dsr_msg'] = array(
				'#type' => 'item',
				'#weight' => -19,
				'#description' => '<div><span style="color:red;">Fields Mark with </span>(<span style="color:#FFAE00;">*</span>) <span style="color:red;"> is mandatory!</span></div>'
				);
				$form['#after_build'] = array('_hide_last_modified_date_fields');
		}
		$form['path']['#access'] = FALSE;
		$form['menu']['#access'] = FALSE;
		$form['author']['#access'] = FALSE;
		$form['options']['#access'] = FALSE;
		$form['comment_settings']['#access'] = FALSE;
		$form['revision_information']['#access'] = FALSE;
		//New submit button creation
		unset($form['buttons']['submit']);
		$form['buttons']['preview']['#weight'] = 19;
		$form['buttons']['dsr_submit'] = array(
			  '#type' => 'submit',
			  '#weight' => 20,
			  '#value' => t('Save'),
			  '#submit' => array('node_form_submit'),
			'#attributes' => array("onclick" => "javascript: return confirm('Are you sure');this.value='Please Wait...'; this.disabled = true;"),
		);

		$rs_rid = db_result(db_query("select rr.name from {users_roles} ur inner join {role} rr on ur.rid=rr.rid where ur.uid='".$user->uid."' "));

		if($rs_rid == 'salesperson' && arg(2)=='edit') {
			$form['#after_build'][] = 'merchant_dsr_after_build';
			$form['#after_build'] = array('_test_set_cck_field_to_hidden');
		}
		$form['#validate'][] = 'y2cfmerchant_validate_dsr_time_line';
	}
}

function y2cf_comment_status_submit($form, &$form_state) {
	$node = arg(0);
	$nid = arg(1);
	$n_nid = arg(2);
	$cid = arg(3);
	global $user;
	$status = $form_state['values']['comment_status'];
	if(!empty($cid)) {
		$rnid = arg(2);
		$fr_cid = db_result(db_query("select max(cid) from {comments} where `nid` = '".$n_nid."' and `uid` = '".$user->uid."' and `pid` = '".$cid."' "));
		db_query("update `comments` set `call_status` = '".$status."' where `cid` = '".$fr_cid."' and `nid` = '".$rnid."' and `uid` = '".$user->uid."' and `pid` = '".$cid."' ");
	}else{
		$fr_cid = db_result(db_query("select max(cid) from {comments} where `nid` = '".$n_nid."' and `uid` = '".$user->uid."' and `pid` = 0 "));
		db_query("update `comments` set `call_status` = '".$status."' where `cid` = '".$fr_cid."' and `nid` = '".$n_nid."' and `uid` = '".$user->uid."' and `pid` = 0 ");
	}
}
function _hide_last_modified_date_fields($form, &$form_state) {
	$form['field_dsr_mod_call_stage']['#type'] = 'hidden';
	return $form;
}
function outlet_merchant_fields_hide($form, &$form_state) {
	$form['title']['#type'] = 'hidden';
	$form['field_mo_hop_outlet_code'][0]['value']['#type'] = 'hidden';
	$form['field_mo_outlet_type']['value']['#type'] = 'hidden';
	$form['field_mo_loc_address_1'][0]['value']['#type'] = 'hidden';
	$form['field_mo_loc_address_2'][0]['value']['#type'] = 'hidden';
	$form['field_mo_loc_landmark'][0]['value']['#type'] = 'hidden';
	$form['field_mo_landmark2'][0]['value']['#type'] = 'hidden';
	$form['field_mo_hop_contact_person'][0]['value']['#type'] = 'hidden';
	$form['field_mo_hop_cp_designation'][0]['value']['#type'] = 'hidden';
	$form['field_hopper_city_hfa']['value']['#type'] = 'hidden';
	$form['field_hopper_city_hfa']['#type'] = 'hidden';
	$form['field_mo_hopper_state']['value']['#type'] = 'hidden';
	$form['field_mo_appointmengt']['value']['#type'] = 'hidden';
	$form['field_mo_oprational_timings'][0]['value']['#type'] = 'hidden';
	$form['field_hop_outlet_nvon'][0]['value']['#type'] = 'hidden';
	$form['field_hop_no_tbls_bed_mo'][0]['value']['#type'] = 'hidden';
	$form['field_hop_poster_requir_mo'][0]['value']['#type'] = 'hidden';
	$form['field_hop_danglers_mo'][0]['value']['#type'] = 'hidden';
	$form['field_hop_tent_card_requ_mo'][0]['value']['#type'] = 'hidden';
	$form['field_hop_standees_mo'][0]['value']['#type'] = 'hidden';
	$form['field_hop_stickers_mo'][0]['value']['#type'] = 'hidden';
	$form['field_hopper_other_promo_mat'][0]['value']['#type'] = 'hidden';
	$form['field_mo_hop_sms_thathas'][0]['value']['#type'] = 'hidden';
	$form['field_hop_out_latitude_mo'][0]['value']['#type'] = 'hidden';
	$form['field_hop_mer_longitude_mo'][0]['value']['#type'] = 'hidden';
	$form['field_hop_mer_remarks_mo'][0]['value']['#type'] = 'hidden';
	$form['field_mo_holidays']['value']['#type'] = 'hidden';
	$form['field_hop_outlet_nvon']['value']['#type'] = 'hidden';
	$form['field_mo_hop_zipcode'][0]['#type']['number'] = 'hidden';
	$form['field_mo_hop_cp_emailid'][0]['#type']['email_textfield'] = 'hidden';
	$form['field_con_per_mon_mo'][0]['#type']['phone_number'] = 'hidden';
	$form['field_mo_cou_det_rec_mob'][0]['#type']['phone_number'] = 'hidden';
	$form['field_mo_outlet_lnd_no'][0]['#type']['phone_number'] = 'hidden';
	$form['field_mo_app_mon_num'][0]['#type']['phone_number'] = 'hidden';
	$form['field_hop_mnfwsmssend_mo'][0]['#type']['phone_number'] = 'hidden';
	$form['buttons']['preview']['#type']['submit'] = 'hidden';
	$form['buttons']['submit']['#value'] = 'Save Outlet';
	return $form;
}
function _test_set_cck_field_to_hidden($form, &$form_state){
	global $user;
	$form['field_dsr_outlet_visited'][0]['value']['#type'] = 'hidden';
	$form['title']['#type'] = 'hidden';
	$form['field_merchant_genree']['value']['#type'] = 'hidden';
	$form['field_dsr_call_stage']['value']['#type'] = 'hidden';
	$form['field_dsr_st_city_hfa']['value']['#type'] = 'hidden';
	$form['field_dsr_st_city_hfa']['#type'] = 'hidden';
	$nid = arg(1);
	$merchants_details = db_fetch_array(db_query("select n.title,ctyd.field_dsr_outlet_visited_value,ctyd.field_merchant_genree_value,ctyd.field_dsr_call_stage_value, ctyd.field_dsr_st_city_hfa_value from {content_type_y2cf_dsr} ctyd inner join {node} n on ctyd.nid=n.nid where n.nid = '".$nid."' "));

	$form['merdet']['dscfsdfsfsd'] = array(
		'#weight' => -1,
		'#type' => 'item',
		'#description' => '<table>
		 <tr>
		   <td>HFA</td>
			<td class="dsrnoneditfields">'.ucwords(get_only_term_name($merchants_details['field_dsr_st_city_hfa_value'])).'</td>
			<td>City</td><td class="dsrnoneditfields">'.ucwords(get_only_term_name(get_parent_tid_by_tid($merchants_details['field_dsr_st_city_hfa_value']))).'</td>
			</tr>

			<tr>
				<td>Outlet Visited</td>
				<td class="dsrnoneditfields">'.ucwords($merchants_details['title']).'</td><td>Genre</td><td class="dsrnoneditfields">'.ucwords(get_only_term_name($merchants_details['field_merchant_genree_value'])).'</td>
			</tr>

			<tr>
				<td>Initial Call Stage Visited</td>
				<td class="dsrnoneditfields">'.ucwords(get_only_term_name($merchants_details['field_dsr_call_stage_value'])).'</td><td>&nbsp;</td><td>&nbsp;</td>
			</tr>
		</table>',
	);
	return $form;
}
function merchant_offerdisable_after_build() {
	merchant_offer_fix_disabled($form['field_merchant_type']);
	return $form;
}
function merchant_offer_fix_disabled(&$elements) {
	foreach (element_children($elements) as $key) {
		if (isset($elements[$key]) && $elements[$key]) {
			_mysnippet_offer_fix_disabled($elements[$key]);
		}
	}
	if (!isset($elements['#attributes'])) {
		$elements['#attributes'] = array();
	}
	$elements['#attributes']['readonly'] = 'readonly';
}


function merchant_dsr_after_build($form, &$form_state) {
	return $form;
}
function merchant_dsr_fix_disabled(&$elements) {
	foreach (element_children($elements) as $key) {
		if (isset($elements[$key]) && $elements[$key]) {
			// Recurse through all children elements.
			_mysnippet_fix_disabled($elements[$key]);
		}
	}

	if (!isset($elements['#attributes'])) {
		$elements['#attributes'] = array();
	}
	$elements['#attributes']['readonly'] = 'readonly';
}

function user_submit_profile($form, &$form_state) {
	global $user;
	global $base_url;
	$slt_rm_id = $form_state['values']['user_id'];
	$user_id = db_result(db_query("select max(uid) from users "));
	db_query("UPDATE `users` SET `rm_id` = '".$slt_rm_id."' WHERE `uid` = '".$user_id."' ");
/*Mail send to sm,rm and admin

	$rs_rid  = get_user_role_id($slt_rm_id);
	$admin1_mail = 'priya@y2cf.com';
  $admin2_mail = 'rupesh@y2cf.com';

  $sender = 'izhar@y2cf.com';
  $subject = "DSR new user";
  $body = 'Dear Rm, A new user created under ("'.$slt_rm_id.'") for the post of sales executive/';
  $plaintext = FALSE;
  $headers = array();

	if($rs_rid == 'salesmanager') {
				$sm_email = db_result(db_query("Select mail from {users} where uid='".$slt_rm_id."' "));
		$sm_rm_id = db_result(db_query("Select rm_id from {users} where uid='".$slt_rm_id."' "));
		$sm_rm_email = db_result(db_query("Select mail from {users} where uid='".$sm_rm_id."' "));

    mimemail($sender, $sm_email, $subject, $body, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
    mimemail($sender, $sm_rm_email, $subject, $body, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
    mimemail($sender, $admin1_mail, $subject, $body, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
    mimemail($sender, $admin2_mail, $subject, $body, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
	}
	elseif($rs_rid == 'reporting manager') {
		$rm_email = db_result(db_query("Select mail from {users} where uid='".$slt_rm_id."' "));


    $rm_mail = $rm_email;

    mimemail($sender, $rm_mail, $subject, $body, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
    mimemail($sender, $admin1_mail, $subject, $body, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
    mimemail($sender, $admin2_mail, $subject, $body, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
	}
*/
	$redirect_url = $base_url.'/admin/user/user/create';
	drupal_goto($redirect_url);
}
function _mysnippet_after_build($form, &$form_state) {
	_mysnippet_fix_disabled($form['field_reson_for_sales_revert']);
	return $form;
}
function _mysnippet_fix_disabled(&$elements) {
	foreach (element_children($elements) as $key) {
		if (isset($elements[$key]) && $elements[$key]) {
			_mysnippet_fix_disabled($elements[$key]);
		}
	}

	if (!isset($elements['#attributes'])) {
		$elements['#attributes'] = array();
	}
	$elements['#attributes']['disabled'] = 'disabled';
}
function y2cfmerchant_validate_merchant_name($form, &$form_state) {
	$merchants_sql = db_fetch_array(db_query("select nid from {node} where title='".trim($form_state['values']['title'])."' "));
	if($merchants_sql['nid']) {
		form_set_error('title',"This merchant already exist...Please choose another name");
	}
}

/*
 * At the time of submit , there are lot of business logic, Email Sending, SMS sending
 *
 */
function y2cfmerchant_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
	global $base_url;
	global $user;
	/*
	 *Merchants outlet	INSERT
	 */
	if ($node->type == 'merchant_outlet' && $op=='insert') {
		$merchant_id = arg(3);
		$outlet_id = db_result(db_query	("select max(nid) as merc_id from {node} where uid= '".$user->uid."' and type= 'merchant_outlet' "));
		if($outlet_id !=0 || $outlet_id != NULL) {
			db_query("update {content_type_merchant_outlet} set field_hopper_merchant_olt_nid = '".$merchant_id."' where nid= '".$outlet_id."' ");
			$clk_here_mer_outlet = $base_url.'/y2cf/merchantsoutlet/'.$merchant_id;
			$clik_here_url = l('Click here', $clk_here_mer_outlet);
			$add_more_outlet = $base_url.'/node/add/merchant-outlet/'.$merchant_id;
			$clik_here_more_outlet = l('Click here', $add_more_outlet);
			if (arg(0) == 'content') {
				$message = "Merchant Outlet added successfully! ".$clik_here_url. " to view outlets for this merchant";
				$msg_add_outlet = $clik_here_more_outlet. " to add more outlet for this merchant! ";
				drupal_set_message($message);
				drupal_set_message($msg_add_outlet );
			}
			else {
				$message = '';
				$msg_add_outlet = '';
			}



		}else{
			form_set_error("title","Merchant ID not matching");
		}

	}
	
/*
	* Merchants outlet	Update
*/

	if ($node->type == 'merchant_outlet' && $op=='update') {
		global $user;
		global $base_url;
		$rs_rid  = get_user_role_id($user->uid);
		$oltid = arg(1);
		$outlet_vid = db_result(db_query("select vid as merc_id from {node} where type= 'merchant_outlet' and nid='".$oltid."' "));
    	$merchant_id = db_result(db_query("select distinct field_hopper_merchant_olt_nid from {content_type_merchant_outlet} where nid= '".$oltid."' "));
    	sleep(1);//users to stop execution for one second
		db_query("update {content_type_merchant_outlet} set field_hopper_merchant_olt_nid = '".$merchant_id."' where vid = '".$outlet_vid."' ");
	
		//At the time of go live ... update automated date
		if($rs_rid == 'y2cfoperations' || $rs_rid == 'operationhead') {
      		$go_live_end_date = date("m/d/Y");
      		$go_live_sts = $node->field_hop_ops_glivsts_mo[0]['value'];
      		if($go_live_sts=='Done' || $go_live_sts=='Not Done') {
      			db_query("update {content_type_merchant_outlet} set field_hop_ops_glendat_mo_value = '".$go_live_end_date."' where vid = '".$outlet_vid."' ");
       }
	}
//At the time of Re - Validation of outlets
	$user_rols = get_all_user_roles($user->uid);
	
	if($rs_rid == 'y2cfoperations' || $rs_rid == 'operationhead') {
		$go_live_end_date = date("m/d/Y");
		$go_live_sts = $node->field_hop_ops_glivsts_mo[0]['value'];
		if($go_live_sts=='Done' || $go_live_sts=='Not Done') {
			db_query("update {content_type_merchant_outlet} set field_hop_ops_glendat_mo_value = '".$go_live_end_date."' where vid = '".$outlet_vid."' ");
		}
		
		
		
	}
	
	
	
	
//  

      
      //$roles = explode(",", $user_rols);
      

    	if($rs_rid == 'salesperson') {
        $sales_go_live_end_date = date("m/d/Y");
        $sales_go_live_sts = $node->field_sales_hop_ops_glivsts_mo[0]['value'];
        if($sales_go_live_sts == 'Done' || $sales_go_live_sts == 'Not Done') {
          db_query("update {content_type_merchant_outlet} set field_sales_hop_ops_glendat_mo_value = '".$sales_go_live_end_date."' where vid = '".$outlet_vid."' ");
        }
       
       
//Validation status
       $re_validation_sts = $node->field_hop_revalidation[0]['value'];
       if($re_validation_sts=='Accepted' || $re_validation_sts=='Accepted with changes' || $re_validation_sts=='Not accepted') {
       	$re_validation_date = time();
       	
       	$acc_date_res = db_result(db_query("Select field_hop_revalidation_dis_dt_value from {content_type_merchant_outlet} where vid='".$outlet_vid."' "));
       	if(empty($acc_date_res)) {//1356333255
//print $re_validation_date;die;
       		db_query("update {content_type_merchant_outlet} set field_hop_revalidation_dis_dt_value = '".$re_validation_date."' where vid = '".$outlet_vid."' ");
       	}
       }
    }
//Mail Sending process
    $sender = 'connect@hoppr.com';
    $subject = "Ops Rejection ". date("Y-m-d H:i:s");
    $plaintext = FALSE;
    $headers = array();
    $outlet_id = $node->nid;
    //Who is salesperson
    $sp_id = db_result(db_query("SELECT uid FROM {node} WHERE nid = %d", $outlet_id));
    $sp_email = db_result(db_query("SELECT mail FROM {users} WHERE uid = %d", $sp_id));
    
    
//Mail send to rejected cases when done by TC
    foreach($user_rols as $rol_val) {
    	
    	if($rol_val== 'hoppertelecallingops' || $rol_val == 'operationhead') { 
    	//Rejected by merchants   Language Issue   Data Discrepancy
	    	$rejected_status = $node->field_hop_ops_all_remrk_mo[0]['value'];
	    	if($rejected_status == 'Rejected by Tele-Agent' || $rejected_status== 'Sales team meeting request' || $rejected_status== 'Rejected by merchants' || $rejected_status== 'Language Issue' || $rejected_status== 'Data Discrepancy') {
	    	$tc_dept = 'varun@hoppr.com';
	    	$body_general_mail .= " Merchant Name: ".$node->title.'<br />';
	    	$body_general_mail .= " Rejected Status: ".$rejected_status.'<br />';
	    	$body_general_mail .= " Reason of rejection: ".$node->field_hop_ops_all_remrk_mo[0]['value']."<br />".$node->field_hop_ops_tc_rmks[0]['value'];
	    	//mail to TC
	    	mimemail($sender, $tc_dept, $subject, $body_general_mail, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
	    	//mail to salesperson
	    	mimemail($sender, $sp_email, $subject, $body_general_mail, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
	    	drupal_set_message("Mail sent successfully.");
	    
	    	}
    	}
    }
    
    //Mail send to rejected cases when done by OE    
    if($rs_rid == 'y2cfoperations' || $rs_rid == 'operationhead') {
    	$oe_rej_status = $node->field_hop_offer_ops_status_mo[0]['value'];
    	if($oe_rej_status == 'Rejected') {
    		$oe_email = db_result(db_query("SELECT mail FROM {users} WHERE uid = %d", $user->uid));
    		$body_oe_rej .= " Merchant Name: ".$node->title.'<br />';
    		$body_oe_rej .= " Rejected Status: ".$oe_rej_status.'<br />';
    		$oe_reason_of_rejection = get_ops_exe_ror_overallrejreson($outlet_id);
    		$body_oe_rej .= " Reason of rejection: ".$oe_reason_of_rejection."<br />".$node->field_hop_ror_oth_cmnts[0]['value'];
    		//mail to OE
    		mimemail($sender, $oe_email, $subject, $body_oe_rej, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
    		//mail to salesperson
    		mimemail($sender, $sp_email, $subject, $body_oe_rej, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
    		drupal_set_message("Mail sent successfully.");
    		
    	}
    }

//Merchant outlet status update by OPS Head..... when bulk upload happens...due to versioning system
    $mer_vid = db_result(db_query("select vid from {node} where type= 'merchant_outlet' and nid='".$oltid."' "));
    $rs_ops_sts = db_fetch_array(db_query("select field_hop_ops_oh_ds_sts_mo_value as opssts, field_hop_out_latitude_mo_value, field_hop_mer_longitude_mo_value, field_hoppr_ofr_upld_value, field_hop_ofr_upld_cmnts_value, field_hoppr_offr_test_value, field_hop_off_test_cmnts_value, field_hop_pos_nt_del_mo_value, field_hop_pos_oa_status_mo_value, field_hop_pos_del_dt_mo_value, field_hop_ops_acc_rmrks_mo_value as ops_cmnts,field_hoppr_creativedsgnab_out_value,field_hop_ops_glendat_mo_value,field_sales_hop_ops_glendat_mo_value, field_pro_script_value,field_hop_cr_csvlmd_value,field_hop_oh_csvlmd_value,field_hop_ou_csvlmd_value,field_hop_pro_lmdate_value,field_hop_revalidation_appval_value, field_hop_revalidation_dis_dt_value from {content_type_merchant_outlet} where vid= '".$mer_vid."' "));

    db_query("update {content_type_merchant_outlet} set field_hop_ops_oh_ds_sts_mo_value = '".$rs_ops_sts['opssts']."',field_hop_ops_acc_rmrks_mo_value = '".$rs_ops_sts['ops_cmnts']."',field_hop_out_latitude_mo_value = '".$rs_ops_sts['field_hop_out_latitude_mo_value']."',field_hop_mer_longitude_mo_value = '".$rs_ops_sts['field_hop_mer_longitude_mo_value']."',field_hoppr_ofr_upld_value = '".$rs_ops_sts['field_hoppr_ofr_upld_value']."',field_hop_ofr_upld_cmnts_value = '".$rs_ops_sts['field_hop_ofr_upld_cmnts_value']."',field_hoppr_offr_test_value = '".$rs_ops_sts['field_hoppr_offr_test_value']."',field_hop_off_test_cmnts_value = '".$rs_ops_sts['field_hop_off_test_cmnts_value']."',field_hop_pos_del_dt_mo_value = '".$rs_ops_sts['field_hop_pos_del_dt_mo_value']."',field_hop_pos_oa_status_mo_value = '".$rs_ops_sts['field_hop_pos_oa_status_mo_value']."',field_hop_pos_nt_del_mo_value = '".$rs_ops_sts['field_hop_pos_nt_del_mo_value']."',field_hoppr_creativedsgnab_out_value = '".$rs_ops_sts['field_hoppr_creativedsgnab_out_value']."',field_hop_ops_glendat_mo_value = '".$rs_ops_sts['field_hop_ops_glendat_mo_value']."', field_sales_hop_ops_glendat_mo_value = '".$rs_ops_sts['field_sales_hop_ops_glendat_mo_value']."', field_pro_script_value = '".$rs_ops_sts['field_pro_script_value']."', field_hop_cr_csvlmd_value = '".$rs_ops_sts['field_hop_cr_csvlmd_value']."',field_hop_oh_csvlmd_value = '".$rs_ops_sts['field_hop_oh_csvlmd_value']."',field_hop_ou_csvlmd_value = '".$rs_ops_sts['field_hop_ou_csvlmd_value']."',field_hop_pro_lmdate_value = '".$rs_ops_sts['field_hop_pro_lmdate_value']."',field_hop_revalidation_appval_value = '".$rs_ops_sts['field_hop_revalidation_appval_value']."', field_hop_revalidation_dis_dt_value = '".$rs_ops_sts['field_hop_revalidation_dis_dt_value']."' where vid = '".$mer_vid."' ");

    drupal_set_message("Outlet updated successfully! ");


	}

	/****			Merchants offer INSERT		****/
	if ($node->type == 'offer_detail' && $op=='insert') {
//  update comment on node table for comment status should be = 2
		$offer_vid = db_result(db_query("select max(vid) from {node} where uid= '".$user->uid."' and type= 'offer_detail' "));
		$vid_id = db_query("select delta,field_merc_out_nid from {content_field_merc_out} where vid = '".$offer_vid."' ");
		while($rs_field_merc_out_nid = db_fetch_array($vid_id)) {
			db_query("UPDATE `node` SET `comment` = '2' WHERE `nid` = '".$rs_field_merc_out_nid['field_merc_out_nid']."' and type = 'merchant_outlet' and uid= '".$user->uid."' ");
		}

		//           ***************  SENDING MAIL***************     //



		//Mail send to merchants...different outlets.....salesperpon....saleshead.....and operation team member
		
		//$subjects = 'Merchants offer detail';
        $subject = $node->title;
		$msg_body_email = mail_message_to_merchant_format($node->title);
		$msg_body_alt_mail = mail_message_to_merchant_format($node->title);
        global $base_url;
        $path_theme = $base_url.'/'.path_to_theme();
        $logo_img = $path_theme.'/images/hoppr-logo.png';
        $sp =  $path_theme.'/images/sp.png';
        $fb = $path_theme.'/images/fb.png';
        $gplu = $path_theme.'/images/gplu.png';
        $twitter = $path_theme.'/images/twitter.png';
        $signatory_name  = strtolower($node->field_merchant_title[0]['value'])."&nbsp;".strtolower($node->field_merchant_f_name[0]['value'])."&nbsp;".strtolower($node->field_merchant_last_name[0]['value']);
        $sign_up_mail_body = '<div id="container" style="position:relative; margin-left:auto; margin-right:auto; width:700px; border:solid 6px #002060; padding:5px"><img src="'.$logo_img.'" width="186" height="88" alt="hoppr" style=" float:right; display:block" /><br /><br /><br><br />
<span >
<font style="color:#D9096E; font-size: 20px"id="text" face="Arial"><strong>
dear '.$signatory_name.',</strong></font><br />

<p>congratulations! you are now on board with india’s fastest growing location based check-in game.</span>
<p>thousands of hoppr users check in to many places every day. at 6000 of such places, they are
  delighted to discover specials. your place(s) is now one of them!</p>
<p>one of our happy hoppr will get in touch with you shortly to confirm your sign up and will take<br />
  you through the next steps involved before take your special live on hoppr.</p>
<p>get in touch with us anytime for any help or feedback. drop us an email at <a href="mailto:connect@hoppr.com">connect@hoppr.com</a></p>
<span ><font style="font-size:15px" color="#000000">
<p></font> </span>
<p><img src="'.$sp.'" width="100%"  /><br />
  <br />
</p>
<font style="font-size:15px" color="#000000" face="Calibri"></font>
<hr style="height:3px; color:#F03; background-color:#F06; border:0px;" />
<p><font style="font-size:19px" color="#002060" face="Arial"><b>team hoppr |</b></font><font style="font-size:19px" color="#D9096E" face="Arial"><b> </b></font><font style="font-size:13px" color="#000000" face="Times New Roman">visit us at:</font><font style="font-size:13px" color="#002060" face="Times New Roman"> </font><font style="font-size:12px" color="#002060" face="Arial"><u>www.hoppr.com </u></font><font style="font-size:15px" color="#000000" face="Calibri"> </font><font style="font-size:19px" color="#002060" face="Arial"><b>| </b></font><font style="font-size:13px" color="#000000" face="Times New Roman">follow us</font><a href="http://www.facebook.com/hoppinghoppr"><img src="'.$fb.'" width="30" height="30" alt="facebook" longdesc="http://www.facebook.com/hoppinghoppr" /></a><a href="https://plus.google.com/u/0/107337253619882914664/posts"><img src="'.$gplu.'" width="30" height="30" alt="google+" longdesc="https://plus.google.com/u/0/107337253619882914664/posts" /></a><a href="https://twitter.com/#!/hoppinghoppr"><img src="'.$twitter.'" width="30" height="30" alt="twitter" longdesc="https://twitter.com/#!/hoppinghoppr" /></a></p>
</div>';
        $sender = 'connect@hoppr.com';
        $plaintext = FALSE;
        $headers = array();
        //$merchant_email = $node->field_merchant_email_id[0]['email'];
		//$merchant_alt_mail = $node->field_mer_alt_email_id[0]['email'];
        //$merchant_email = 'vibhuti@hoppr.com';
        //$merchant_alt_mail = 'vibhuti@hoppr.com';
        
        //mimemail($sender, $merchant_email, $subject, $sign_up_mail_body, $plaintext = NULL, $headers=array('name'=>'portal'), $text = NULL, $attachments = array(), $mailkey = '');
        //mimemail($sender, $merchant_alt_mail, $subject, $sign_up_mail_body, $plaintext = NULL, $headers=array('name'=>'portal'), $text = NULL, $attachments = array(), $mailkey = '');
        /*
        if(!empty($merchant_alt_mail)) {
            mimemail($sender, $merchant_alt_mail, $subject, $sign_up_mail_body, $plaintext = NULL, $headers=array('name'=>'portal'), $text = NULL, $attachments = array(), $mailkey = '');
        }
    */
    
		$merchant_id = db_result(db_query("select max(nid) as merc_id from {node} where uid= '".$user->uid."' and type= 'offer_detail' "));
		$merchantoffer_redirect_url = $base_url.'/node/add/merchant-outlet/'.$merchant_id;
		$clik_here_more_outlet = l('Click here', $merchantoffer_redirect_url);



		//When merchant offer added ....by default one outlet also inserted to the database with only one field as merchant outlet name.

		$outlet_name = $node->title;
		$out_node = new stdClass();
		$out_node->is_new = 1;
		$out_node->type = "merchant_outlet";
		$out_node->uid = $user->uid;
		$out_node->name = $user->name;
		$out_node->status = 1;
		$out_node->created = time();
		$out_node->changed = time();
		$out_node->title = $outlet_name;
		node_save($out_node);
		$outlet_nid = $out_node->nid;
		db_query("UPDATE `content_type_merchant_outlet` SET `field_hopper_merchant_olt_nid` = '".$node->nid."' WHERE `nid` = '".$outlet_nid."' ");

		$mercha_outlet_edit_redirect_url = $base_url.'/node/'.$outlet_nid.'/edit?destination=y2cf/merchantsoutlet/'.$merchant_id;
		$clik_here_edit_outlet = l('Click here', $mercha_outlet_edit_redirect_url);
		drupal_set_message("One merchant outlet is added by default with only outlet Name. You can edit this outlet.");
		drupal_set_message($clik_here_edit_outlet. " to edit merchant outlet and add more outlets for this merchant! ");
		$merchant_outlet_view = $base_url.'/y2cf/merchantsoutlet/'.$merchant_id;
		$clik_here_edit_outlet = l('Click here', $merchant_outlet_view);
		drupal_set_message($clik_here_edit_outlet. " to view merchant outlet! ");
  }

  
  
  
//Update offer detail
	if ($node->type == 'offer_detail' && $op=='update') {
    global $user;
    global $base_url;
    $merid = arg(1);
    $rs_rid  = get_user_role_id($user->uid);
    $sender = 'connect@hoppr.com';
    
    $mer_vid = db_result(db_query("select vid from {node} where type= 'offer_detail' and nid='".$merid."'  "));
    $rs_ops_sts = db_fetch_array(db_query("select field_hoppr_new_mail_comm_value ,field_hop_mal_com_snt_on_value from {content_type_offer_detail} where vid= '".$mer_vid."' "));
    db_query("update {content_type_offer_detail} set field_hoppr_new_mail_comm_value = '".$rs_ops_sts['field_hoppr_new_mail_comm_value']."',field_hop_mal_com_snt_on_value = '".$rs_ops_sts['field_hop_mal_com_snt_on_value']."', field_hop_ag_hrd_rcv_sts_value='".$rs_ops_sts['field_hop_ag_hrd_rcv_sts_value']."' where vid = '".$mer_vid."' ");

//Mail sending process
	
//If operation done by Documentation, and if any rejection done then a mail sent to salesperson... Rejected hoppertelecallingops
    if($rs_rid == 'operationmngr' || $rs_rid == 'hoppertelecallingops' || $rs_rid == 'operationhead' || $rs_rid == 'y2cfmanager') {
    	$docs_rejected_status = $node->field_hop_ops_agr_sta[0]['value'];
    	if($docs_rejected_status == 'Rejected') {
	    	$subject = "Salesportal- Rejection Status ". date("Y-m-d H:i:s");
	    	$plaintext = FALSE;
	    	$headers = array();
	    	$sp_uid = db_result(db_query("SELECT uid FROM {node} WHERE nid = %d", $node->nid));
	    	$sp_email = db_result(db_query("SELECT mail FROM {users} WHERE uid = %d", $sp_uid));
	    	$body_docs_rej .= " Merchant Name: ".$node->title.'<br />';
	    	$body_docs_rej .= " Rejection Status: ".$node->field_hop_ops_agr_sta[0]['value']."<br />";
	    	$rs_ops_manager_ror = get_ops_manager_ror($node->nid);
	    	$body_docs_rej .= " Reason of rejection: ".$rs_ops_manager_ror."<br />";
	    	$body_docs_rej .= "Remarks ".$node->field_hop_mo_om_comments[0]['value'];
	    	mimemail($sender, $sp_email, $subject, $body_docs_rej, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
	    	drupal_set_message("Mail sent successfully to salesperson");
    	}
    }
//if edited by salesperson, a mail sent to vibhuti,varun,
/*
    
	if($rs_rid == 'salesperson') {
		  $subject = "Daily Ops MIS ". date("Y-m-d H:i:s");
		  $body_general_mail = $change_msg;
		  $plaintext = FALSE;
		  $headers = array();
		  $recipient_testing = 'tarun@hoppr.com';
          $docs_dept = 'vibhuti@hoppr.com';
          $tc_dept = 'varun@hoppr.com';

      //Who is sm/rm
      $sm_id = db_result(db_query("SELECT rm_id FROM {users} WHERE uid = %d", $user->uid));
      $sm_email = db_result(db_query("SELECT mail FROM {users} WHERE uid = %d", $sm_id));
        $body_general_mail .= "Salesperson : ".get_salesperson_name($user->uid).'<br />';
		  $body_general_mail .= " Merchant Name: ".$node->title.'<br />';
		  $body_general_mail .= " Rejection Status: ".$node->field_hoppr_rej_cases[0]['value'];
//mail to ops head
		  mimemail($sender, $recipient_testing, $subject, $body_general_mail, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
//mail to Docs
		  mimemail($sender, $docs_dept, $subject, $body_general_mail, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
//mail to TC
		  mimemail($sender, $tc_dept, $subject, $body_general_mail, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
//mail to sm or rm
        if($sm_email != 'priya@hoppr.com') {
            mimemail($sender, $sm_email, $subject, $body_general_mail, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
        }
      $rm_id = db_result(db_query("SELECT rm_id FROM {users} WHERE uid = %d", $sm_id));

      if(!empty($rm_id)) {
      	$rm_email = db_result(db_query("SELECT mail FROM {users} WHERE uid = %d", $rm_id));
        if($rm_email != 'priya@hoppr.com') {
            mimemail($sender, $rm_email, $subject, $body_general_mail, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
        }
      }
      drupal_set_message("Mail sent successfully to respective persons");
    }
    */
    
    
    
   /* 
    //After update this form, users is to redirect to new rejected case status update form
	$merchant_offer_nid = arg(1);
    $merchant_offer_vid = db_result(db_query("select vid from {node} where nid ='".$merchant_offer_nid."' "));
    $rej_cas_edit_url = $base_url.'/node/add/mo-rm-rej-cases/'.$merchant_offer_nid.'?destination=y2cf/merchantsoffers';
    $rej_cas_sts = get_rm_rejected_case_details($merchant_offer_nid);
    $docs_rej_cas_sts = get_docs_rejected_cases($merchant_offer_nid);
    $merchant_detail = db_fetch_array(db_query("select field_hoppr_new_rmsmsts_value,field_hop_ops_agr_sta_value from {content_type_offer_detail} where vid='".$merchant_offer_vid."' "));
    
    
    $out_nid = get_merchant_outlet_nid_on_offer_nid($merchant_offer_nid);
    $merchant_outlet_vid = db_result(db_query("select vid from {node} where nid ='".$out_nid['nid']."' "));
    $oe_rej_cas_sts = get_oe_rejected_cases($out_nid['nid']);
    $oe_gl_rej_cas_sts = get_oe_golive_rejected_cases($out_nid['nid']);
    $outlet_detail = db_fetch_array(db_query("select lll from {content_type_merchant_outlet} where vid='".$merchant_outlet_vid."' "));
    
    if($rs_rid == 'salesperson') {
    
    	if(!empty($merchant_detail['field_hoppr_new_rmsmsts_value']) && ($merchant_detail['field_hoppr_new_rmsmsts_value']=='Rejected') && empty($rej_cas_sts['field_hoprc_rm_rc_sts_value'])) {//RM case
    		//$rej_cas_ed_url = l('Edit Rejected status', $rej_cas_edit_url).'<br />';
    		drupal_goto($rej_cas_edit_url);
    	}elseif($rej_cas_sts['field_hoprc_rm_rc_sts_value']=='Open' || $rej_cas_sts['field_hoprc_rm_rc_sts_value']=='Follow up'){//RM case
    		$ed_rej_cas_edit_url = $base_url.'/node/'.$rej_cas_sts['nid'].'/edit?destination=y2cf/merchantsoffers';
    		//$rej_cas_ed_url = l('Edit Rejected status', $ed_rej_cas_edit_url).'<br />';
    		drupal_goto($ed_rej_cas_edit_url);
    	}elseif(($ops_status_mo=='Rejected' || $ops_status_mo=='Rejected: Cancelled by merchant' || $ops_status_mo=='Rejected: Quality Issue' || $ops_status_mo=='Rejected: Outlet under renovation') && empty($oe_rej_cas_sts['field_hoprc_oe_rc_sts_value'])){//OE case
    
    		$oe_rej_cas_edit_url = $base_url.'/node/add/hoppr-oe-rej-cases/'.$out_nid['nid'].'?destination=y2cf/merchantsoffers';
    		//$rej_cas_ed_url = l('Edit Rejected status', $oe_rej_cas_edit_url).'<br />';
    		drupal_goto($oe_rej_cas_edit_url);
    	}elseif($oe_rej_cas_sts['field_hoprc_oe_rc_sts_value']=='Open' || $oe_rej_cas_sts['field_hoprc_oe_rc_sts_value']=='Follow up'){//OE case
    		$oe_ed_rej_cas_edit_url = $base_url.'/node/'.$oe_rej_cas_sts['nid'].'/edit?destination=y2cf/merchantsoffers';
    		//$rej_cas_ed_url = l('Edit Rejected status', $oe_ed_rej_cas_edit_url).'<br />';
    		drupal_goto($oe_ed_rej_cas_edit_url);
    	}elseif (!empty($merchant_detail['field_hop_ops_agr_sta_value']) && ($merchant_detail['field_hop_ops_agr_sta_value']=='Rejected') && empty($docs_rej_cas_sts['field_hoprc_new_docs_rej_mn_value'])) {//DOCS case
    		$docs_rej_cas_edit_url = $base_url.'/node/add/hoppr-docs-rej-cases/'.$merchant_offer_nid.'?destination=y2cf/merchantsoffers';
    		//$rej_cas_ed_url = l('Edit Rejected status', $docs_rej_cas_edit_url).'<br />';
    		drupal_goto($docs_rej_cas_edit_url);
    	}elseif($docs_rej_cas_sts['field_hoprc_new_docs_rej_mn_value']=='Open' || $docs_rej_cas_sts['field_hoprc_new_docs_rej_mn_value']=='Follow up'){//Docs case
    		$docs_ed_rej_cas_edit_url = $base_url.'/node/'.$docs_rej_cas_sts['nid'].'/edit?destination=y2cf/merchantsoffers';
    		//$rej_cas_ed_url = l('Edit Rejected status', $docs_ed_rej_cas_edit_url).'<br />';
    		drupal_goto($docs_ed_rej_cas_edit_url);
    	}elseif($gl_sts_mo=='Rejected' && empty($oe_gl_rej_cas_sts['field_hoprc_gl_rc_sts_value'])){//OE Go live case
    		$oe_gl_rej_cas_edit_url = $base_url.'/node/add/hoppr-gl-rej-cases/'.$out_nid['nid'].'?destination=y2cf/merchantsoffers';
    		//$rej_cas_ed_url = l('Edit Rejected status', $oe_gl_rej_cas_edit_url).'<br />';
    		drupal_goto($oe_gl_rej_cas_edit_url);
    	}elseif($oe_gl_rej_cas_sts['field_hoprc_gl_rc_sts_value']=='Open' || $oe_gl_rej_cas_sts['field_hoprc_gl_rc_sts_value']=='Follow up'){//OE Go live case
    		$oe_ed_gl_rej_cas_edit_url = $base_url.'/node/'.$oe_gl_rej_cas_sts['nid'].'/edit?destination=y2cf/merchantsoffers';
    		//$rej_cas_ed_url = l('Edit Rejected status', $oe_ed_gl_rej_cas_edit_url).'<br />';
    		drupal_goto($oe_ed_gl_rej_cas_edit_url);
    	}else{
    		$rej_cas_ed_url = drupal_goto($base_url."/y2cf/merchantsoffers");
    	}
    }elseif($rs_rid == 'reporting manager' || $rs_rid == 'salesmanager') {
    	$rej_cas_ed_url = drupal_goto($base_url."/y2cf/merchantsoffers");
    }
    
    */

    //drupal_goto($base_url."/y2cf/merchantsoperation");

}

/***			DSR alteration	INSERT		***/
  if ($node->type == 'y2cf_dsr' && $op=='insert') {
		$today_date = date('m-d-YTH:i:s');
		$exp = explode("T", $today_date);
		$curdate_1=explode("-",$exp[0]);
		$curdate_2=explode(":",$exp[1]);
		$current_date = mktime($curdate_2[0],$curdate_2[1],$curdate_2[2],$curdate_1[0],$curdate_1[1],$curdate_1[2]);
		$vid_id = db_result(db_query("select max(vid) from {node} where uid= '".$user->uid."' "));
		$dsr_title = db_result(db_query("select title from {node} where vid = '".$vid_id."' and uid= '".$user->uid."' "));

		/*Mail Send to RM and Y2CF Manager*/
		$user_role = get_user_role_id($user->uid);
		if($user_role == 'salesperson') {
			$y2cf_admin = 'yash@y2cf.com';
			$y2cf_sales_head = get_saleshead_mail_id($user->uid);
			$y2cf_salesman = $user->mail;
		}else if($user_role == 'reporting manager') {
			$y2cf_admin = 'yash@y2cf.com';
			$y2cf_salesman = $user->mail;
		}



		$redirect_url = $base_url.'/asp/dsr';
		drupal_set_message("DSR added successfully!");
		drupal_goto($redirect_url);

	}

	if ($node->type == 'y2cf_dsr' && $op=='update') {
		$today_date = date('m-d-YTH:i:s');
		$exp = explode("T", $today_date);
		$curdate_1=explode("-",$exp[0]);
		$curdate_2=explode(":",$exp[1]);
		$current_date = mktime($curdate_2[0],$curdate_2[1],$curdate_2[2],$curdate_1[0],$curdate_1[1],$curdate_1[2]);
		$nid = arg(1);
		drupal_set_message("DSR updated successfully!");
		$redirect_url = $base_url.'/asp/dsr';
		drupal_goto($redirect_url);
	}
}

function get_current_timestamp() {
	$today_date = date('m-d-YTH:i:s');
	$exp = explode("T", $today_date);
	$curdate_1=explode("-",$exp[0]);
	$curdate_2=explode(":",$exp[1]);
	$current_date = mktime($curdate_2[0],$curdate_2[1],$curdate_2[2],$curdate_1[0],$curdate_1[1],$curdate_1[2]);
	return $current_date;
}

function get_today_start_timestamp() {
	$start_time_stamp = mktime(0,31,0,date('m'),date('d'),date('Y'));
	return $start_time_stamp;
}

function get_today_end_timestamp() {
	$start_time_end = mktime(23,30,0,date('m'),date('d'),date('Y'));
	return $start_time_end;
}

function get_dsr_closing_start_time(){
	$start_time = mktime(23,30,0,date('m'),date('d'),date('Y'));
	return $start_time;
}
function get_dsr_closing_end_time(){
	$end_time = mktime(23,59,59,date('m'),date('d'),date('Y'));
	return $end_time;
}
function y2cfmerchant_validate_dsr_time_line($form, &$form_state){
	global $user;
	$current_date = get_current_timestamp();
	$start_time = get_dsr_closing_start_time();
	$end_time  = get_dsr_closing_end_time();

	if($user->uid && ($current_date >= $start_time && $current_date <= $end_time)) {
		form_set_error('field_dsr_outlet_visited',"You are not allowed to enter any data From 11 PM IST to 11:59 PM IST");
	}

	if(arg(0)=='node' && arg(1)=='add' && arg(0)=='y2cf-dsr'){
		$sql_merchant = db_result(db_query("select nid from {node} where title='".$form_state['values']['title']."' and type='y2cf_dsr' "));
		if($sql_merchant) {
			form_set_error('title', "outlet is already exist.");
		}
	}



}

function hoppr_lat_lon_atedit_after_build($form, &$form_state) {
$val_lat = $form_state['values']['field_hop_out_latitude_mo'];
    $val_long = $form_state['values']['field_hop_mer_longitude_mo'];
    $hop_latitude = $val_lat[0]['value'];
    $hop_longitude = $val_long[0]['value'];
    
    
    if($hop_latitude == '-' || $hop_latitude=='--' || $hop_latitude=='n/a' || $hop_latitude=='N/A') {
    	form_set_error("field_hop_out_latitude_mo","Please enter a valid latitude");
    }
    if (!(is_numeric($hop_latitude))){
    	form_set_error("field_hop_out_latitude_mo","Please enter a valid latitude");
    }
    if($hop_latitude < '8.05923' || $hop_latitude > '37.09024') {
    	form_set_error("field_hop_out_latitude_mo","Please enter a valid latitude");
    }
    if (!(is_numeric($hop_longitude))){
    	form_set_error("field_hop_mer_longitude_mo","Please enter a valid longitude");
    }
    if($hop_longitude < '67.694458' || $hop_longitude > '97.024658') {
    	form_set_error("field_hop_mer_longitude_mo","Please enter a valid longitude");
    }
    return $form;
}

function hoppr_lat_lon_validate($form, &$form_state) {
    $val_lat = $form_state['values']['field_hop_out_latitude_mo'];
    $val_long = $form_state['values']['field_hop_mer_longitude_mo'];
    $hop_latitude = $val_lat[0]['value'];
    $hop_longitude = $val_long[0]['value'];
    
    
    if($hop_latitude == '-' || $hop_latitude=='--' || $hop_latitude=='n/a' || $hop_latitude=='N/A') {
    	form_set_error("field_hop_out_latitude_mo","Please enter a valid latitude");
    }
    if (!(is_numeric($hop_latitude))){
    	form_set_error("field_hop_out_latitude_mo","Please enter a valid latitude");
    }
    if($hop_latitude < '8.05923' || $hop_latitude > '37.09024') {
    	form_set_error("field_hop_out_latitude_mo","Please enter a valid latitude");
    }
    if (!(is_numeric($hop_longitude))){
    	form_set_error("field_hop_mer_longitude_mo","Please enter a valid longitude");
    }
    if($hop_longitude < '67.694458' || $hop_longitude > '97.024658') {
    	form_set_error("field_hop_mer_longitude_mo","Please enter a valid longitude");
    }
        
}
function y2cfmerchant_validate_offer_for_merchant_name($form, &$form_state) {
	$merc_nid = arg(3);
	if(arg(0)=='node' && arg(1)=='add' && arg(2)=='offer-detail') {
		$sql_merchant = db_result(db_query("select nid from {node} where title='".$form_state['values']['title']."' and type='offer_detail' "));
		if($sql_merchant) {
			form_set_error('title', "Merchant is already exist.");
		}

		$merc_nid_from_frm = $form_state['values']['field_march'][0]['nid'];
		if($merc_nid_from_frm != $merc_nid) {
			form_set_error('field_march', "Choose correct Merchant");
		}
	}
}


function get_mail_template($sql_obj) {
  $change_msg = "";
  while($rs_rec = db_fetch_array($sql_obj)) {

  	$change_msg .= '<div style="background-color:#D0E6DE;font-weight:bold;">Merchant Name :-
      '.$rs_rec['title']. ',
      Sign up date -: '.displat_date_in_excel_format($rs_rec['field_offer_sign_date_value']). ',
      Sign up city -:'.get_only_term_name($rs_rec['field_hop_signup_city_value']). ',
      Signed by :-'.get_salesperson_name($rs_rec['uid']).
      '</div>';

    $change_msg .='<div>
<div><span style="color:blue;font-weight:bold;">1. OE Status:</span> '.$rs_rec['field_hop_offer_ops_status_value'].'</div>
        <div><span style="color:blue;">Reason of rejection by merchant ops:</span> '.$rs_ops_exe.'</div>

        <div><span style="color:#AA0030;font-weight:bold;">2. Document Status:</span> '.$rs_rec['field_hop_ops_agr_sta_value'].'</div>

        <div><span style="color:#AA0030;">Reason of rejection by docs team:</span> '.$rs_ops_manager_ror.'</div>

        <div><span style="color:green;font-weight:bold;">3. TC Status:</span> '.$rs_rec['field_hop_ops_all_remark_value'].'</div>
        <div>
        <span style="color:green;">Reason of rejection by TC team:</span> '.$ror_bytc.'</div>

        <div><span style="color:#AA0030;font-weight:bold;">4. Product Ops Status:</span> '.$rs_rec['field_hop_pro_evaluation_status_value'].'</div>
        <div>
        <span style="color:#AA0030;">Reason of rejection by product ops team:</span> '.$rs_pro_ror.'</div>

        <div><span style="color:blue;font-weight:bold;">5. Keyword:</span> '.$rs_rec['field_hop_ops_pro_keywords'].'</div>

<br />';
  }
  return $change_msg;
}


function y2cfmerchant_cron() {
	global $base_url;
	global $user;
	//$sql_app_offers = "SELECT n.vid as vidhop, n.*, ctod.* FROM {node} n inner join {content_type_offer_detail} ctod on n.vid = ctod.vid WHERE n.changed > UNIX_TIMESTAMP(now())- 43200 ";
    $sql_app_offers = "SELECT DISTINCT  n.title as title,n.vid as vidhop,ctod.nid as merchantid,coutlet.nid as hop_outletid, ctod.*,coutlet.*,n.* FROM {content_type_offer_detail} ctod inner join {node} nn on ctod.vid = nn.vid left outer join {content_type_merchant_outlet} coutlet on ctod.nid = coutlet.field_hopper_merchant_olt_nid inner join {node} n on coutlet.vid = n.vid inner join {node_revisions} nr on n.vid=nr.vid WHERE n.changed > UNIX_TIMESTAMP(now())- 86400 ";
    $sql_app_offers .= " and (coutlet.field_hop_ops_oh_ds_sts_mo_value='Rejected' || ctod.field_hoppr_new_rmsmsts_value='Rejected' || ctod.field_hoppr_new_rmsmsts_value='Rejected' || coutlet.field_hop_offer_ops_status_mo_value='Rejected' || ctod.field_hop_ops_agr_sta_value='Rejected') ";
	$sql_rec_of_day = db_query($sql_app_offers);
    $change_msg = "";
	while($rs_rec = db_fetch_array($sql_rec_of_day)) {
  	//salesmanager
  	  $salesperson_name = get_salesperson_name($rs_rec['uid']);
      $sm_name = get_hoppr_rm_onsp($rs_rec["uid"]);
      $smngr = (!empty($sm_name)) ? 'Sales manager :- '.$sm_name. '' : '';
      //Ops Exe
      $ops_uid = db_result(db_query("SELECT uid FROM {node_revisions} WHERE vid = %d", $rs_rec["vidhop"]));
      //$rs_ops_exe = get_ops_exe_ror($rs_rec['nid']);
    $ror_opsoe_sts = get_ops_exe_ror($rs_rec['merchantid']);
    if(!empty($ror_opsoe_sts)) {
      $rs_ops_exe = get_ops_exe_ror($rs_rec['merchantid']);
    }else{
      $rs_ops_exe = get_ops_exe_ror_dummy($rs_rec['nid']);
    }
    $oe_ror1 = get_ops_exe_ror_overallrejreson($rs_rec['nid']);
    $oe_cmts1 = $rs_rec['field_hop_ror_oth_cmnts_value'];
    $oe_cmts2 = $rs_rec['field_hop_offer_ops_comments_value'];
    if(!empty($oe_cmts1)) {
      $oe_fnl_cmnts = $oe_cmts1;
    }elseif(!empty($oe_cmts2)) {
      $oe_fnl_cmnts = $oe_cmts2;
    }else{
      $oe_fnl_cmnts = '-';
    }
    $rs_ops_manager_ror = get_ops_manager_ror($rs_rec['merchantid']);
    $rs_pro_ror = get_pro_mngr_ror($rs_rec['nid']);
    $ror_bytc = get_ops_sts_ror_by_tc($rs_rec['nid']);

//OH status
      $opshead_sts = get_oh_status($rs_rec['field_hop_ops_oh_ds_sts_value'], $rs_rec['field_hop_ops_oh_ds_sts_mo_value']);
		//OH comments
  if(!empty($rs_rec['field_hop_ops_acc_rmrks_mo_value'])) {
        $opsheadrmks = $rs_rec['field_hop_ops_acc_rmrks_mo_value'];
      }else{
        $opsheadrmks = '-';
      }
$ops_oe_sts =  get_oe_status($rs_rec['field_hop_offer_ops_status_value'], $rs_rec['field_hop_offer_ops_status_mo_value']);
    //TC sts
    if(!empty($rs_rec['field_hop_ops_all_remark_value'])) {
      $tc_sts = $rs_rec['field_hop_ops_all_remark_value'];
    }elseif(!empty($rs_rec['field_hop_ops_all_remrk_mo_value'])) {
       $tc_sts = $rs_rec['field_hop_ops_all_remrk_mo_value'];
    }else{
       $tc_sts = '-';
    }
    //TC cmnts
	$tc_sts_ofr = get_ops_sts_ror_by_tc($rs_rec['merchantid']);
    $tc_sts_out = get_ops_sts_ror_by_tc_merchant_section($rs_rec['nid']);
    if(!empty($tc_sts_ofr)) {
      $tc_ofr_sts = $tc_sts_ofr;
    }elseif(!empty($tc_sts_out)) {
      $tc_ofr_sts = $tc_sts_out;
    }else{
      $tc_ofr_sts = '-';
    }
    $tc_cmts1 = $row['field_hop_ops_tc_hglts_sta_value'];
    $tc_cmts2 = $row['field_hop_ops_tc_rmks_value'];
    if(!empty($tc_cmts1)) {
      $tc_remarks = $tc_cmts1;
    }elseif(!empty($tc_cmts2)) {
      $tc_remarks = $tc_cmts2;
    }else{
      $tc_remarks = '-';
    }
//Last Modified date on portal -:- '.$rs_rec["field_hop_signup_city_value"]. ',
      $change_msg .= '<div style="background-color:#D0E6DE;font-weight:bold;">Merchant Name :-
      '.$rs_rec['title']. ',
      Sign up date -: '.displat_date_in_excel_format($rs_rec['field_offer_sign_date_value']). ',
      Sign up city -:'.get_only_term_name($rs_rec['field_hop_signup_city_value']). ',
      Signed by :-'.$salesperson_name. ',
      Reporting manager :-'.get_reporting_manager_name($rs_rec['uid']). ',
  </div>

<div>

	<div><span style="color:blue;font-weight:bold;">1. OE/TC Status:</span> '.$ops_oe_sts.'/'.$tc_sts.'</div>
        <div><span style="color:blue;">Reason of rejection by merchant ops:</span> '.$rs_ops_exe.' , '.$oe_ror1.'<br>'.$oe_fnl_cmnts.'/'.$tc_ofr_sts.'<br />'.$tc_remarks.'</div>

        <div><span style="color:#AA0030;font-weight:bold;">2. Document Status:</span> '.$rs_rec['field_hop_ops_agr_sta_value'].'</div>

        <div><span style="color:#AA0030;">Reason of rejection by docs team:</span>'.$rs_ops_manager_ror.'<br />'.$rs_rec['field_hop_mo_om_comments_value'].'</div>

        
<br />';
  }
/*
 * Products ops and keyword status
<div><span style="color:#AA0030;font-weight:bold;">4. Product Ops Status:</span> '.$rs_rec['field_hop_pro_evaluation_status_value'].'</div>
        <div>
        <span style="color:#AA0030;">Reason of rejection by product ops team:</span> '.$rs_pro_ror.'</div>

        <div><span style="color:blue;font-weight:bold;">5. Keyword:</span> '.$rs_rec['field_hop_ops_pro_keywords'].'</div>
* */
//For RMS and SMs
    $rm_sql_app_offers = "SELECT n.vid as vidhop, n.*, ctod.* FROM {node} n inner join {content_type_offer_detail} ctod on n.vid = ctod.vid inner join users u on u.uid=n.uid WHERE n.changed > UNIX_TIMESTAMP(now())- 43200";
  $rm_sql_app_offers .= " and (ctod.field_hoppr_new_rmsmsts_value='Rejected' || ctod.field_hoppr_new_rmsmsts_value='Rejected' || ctod.field_hop_offer_ops_status_value='Rejected' || ctod.field_hop_ops_agr_sta_value='Rejected' || ctod.field_hop_ops_all_remark_value='Rejected') ";
//Banglore
  $rm_banglore_sql_app_offers = $rm_sql_app_offers. " and (u.rm_id='68' or u.rm_id='109') ";
  $rm_banglore_sqlobj_offrs = db_query($rm_banglore_sql_app_offers);
  $rm_banglore_body = get_mail_template($rm_banglore_sqlobj_offrs);
//Mumbai
  $rm_mumbai_sql_app_offers = $rm_sql_app_offers. " and u.rm_id='84' ";
  $rm_mumbai_sqlobj_offrs = db_query($rm_mumbai_sql_app_offers);
  $rm_mumbai_body = get_mail_template($rm_mumbai_sqlobj_offrs);
//Kolkata
  $rm_kolkata_sql_app_offers = $rm_sql_app_offers. " and u.rm_id='87' ";
  $rm_kolkata_sqlobj_offrs = db_query($rm_kolkata_sql_app_offers);
  $rm_kolkata_body = get_mail_template($rm_kolkata_sqlobj_offrs);
//Delhi/NCR
  $rm_north_sql_app_offers = $rm_sql_app_offers. " and (u.rm_id='69' or u.rm_id='102' or u.rm_id='124') ";
  $rm_north_sqlobj_offrs = db_query($rm_north_sql_app_offers);
  $rm_north_body = get_mail_template($rm_north_sqlobj_offrs);
//Chennai
  $sm_chennai_sql_app_offers = $rm_sql_app_offers. " and u.rm_id='109' ";
  $sm_chennai_sqlobj_offrs = db_query($sm_chennai_sql_app_offers);
  $sm_chennai_body = get_mail_template($sm_chennai_sqlobj_offrs);
//Delhi
  $sm_delhi_sql_app_offers = $rm_sql_app_offers. " and u.rm_id='69' ";
  $sm_delhi_sqlobj_offrs = db_query($sm_delhi_sql_app_offers);
  $sm_delhi_body = get_mail_template($sm_delhi_sqlobj_offrs);
//Gurgaon
  $sm_gurgaon_sql_app_offers = $rm_sql_app_offers. " and u.rm_id='102' ";
  $sm_gurgaon_sqlobj_offrs = db_query($sm_gurgaon_sql_app_offers);
  $sm_gurgaon_body = get_mail_template($sm_gurgaon_sqlobj_offrs);

//Mail sending process
  $sender = 'connect@hoppr.com';
  $subject = "Daily Ops MIS";
  $body_general_mail = $change_msg;
  $plaintext = FALSE;
  $headers = array();

  $recipient_testing = 'pizharashraf@gmail.com';
  //$rm_mumbai = 'pizharashraf@gmail.com';

  $rec_opshead = 'tarun@hoppr.com';
  $rec_y2cfmanager1 = 'priya@hoppr.com';
  $rec_y2cfmanager2 = 'rupesh@hoppr.com';

  $rm_banglore = 'manjunath@hoppr.com';
  $rm_mumbai = 'tejas@hoppr.com';
  $rm_kolkata = 'danish@hoppr.com';
  $rm_delhi_ncr = 'sanjeev@hoppr.com';

  $sm_chennai = 'arun.k@hoppr.com';
  $sm_delhi = 'nitin@y2cf.com';
  $sm_gurgaon = 'amit.m@hoppr.com';

//Test mail
  mimemail($sender, $recipient_testing, $subject, $body_general_mail, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
//Ops Head
  mimemail($sender, $rec_opshead, $subject, $body_general_mail, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
//Admin 1 (All)
//Admin 2 NSH
//RM Banglore
  mimemail($sender, $rm_banglore, $subject, $rm_banglore_body, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
//RM Mumbai
  mimemail($sender, $rm_mumbai, $subject, $rm_mumbai_body, $plaintext = NULL,$headers=array(),$text = NULL,$attachments = array(),$mailkey = '');
//RM Kolkata
  mimemail($sender, $rm_kolkata, $subject, $rm_kolkata_body, $plaintext = NULL,$headers=array(),$text = NULL,$attachments = array(),$mailkey = '');
//RM North
  mimemail($sender, $rm_delhi_ncr, $subject, $rm_north_body, $plaintext = NULL,$headers=array(),$text = NULL,$attachments = array(),$mailkey = '');
//SM Chennai
  mimemail($sender, $sm_chennai, $subject, $sm_chennai_body, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(), $mailkey = '');
//SM Delhi
  mimemail($sender, $sm_delhi, $subject, $sm_delhi_body, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(),$mailkey = '');
//SM Gurgaon
  mimemail($sender, $sm_gurgaon, $subject, $sm_gurgaon_body, $plaintext = NULL, $headers=array(), $text = NULL, $attachments = array(),$mailkey = '');
  
  
  //DELETE ALL UNWANTED DATA FROM PORTAL AS CONTENT TYPES are.......
  
  /*
   * merchant_mail_comm
   * hoppr_sign_up_mail
   * hoppr_golivedone
   * csv_upload
   * csv_merchant_outlet_upload
   * outlet_del_process
   * creative_design_update
   * keywordupdate
   * offer_upload_pro
   * revalidation_csvupload
   * posdelivery 
   * 
   * 
   * */
  $all_uwdata = db_query("SELECT nid from {node} where type in ('merchant_mail_comm','hoppr_sign_up_mail','hoppr_golivedone','csv_upload','csv_merchant_outlet_upload','outlet_del_process','creative_design_update','keywordupdate','offer_upload_pro','revalidation_csvupload','posdelivery') ");
  while($rs = db_fetch_array($all_uwdata)){
  	node_delete($rs['nid']);
  }
  
  //EXCEL FILE DELETE PROCESS
  
  
}
